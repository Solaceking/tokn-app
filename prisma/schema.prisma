generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String           @unique
  username        String           @unique
  full_name       String?
  avatar_url      String?
  password        String?
  created_at      DateTime?        @default(now()) @db.Timestamptz(6)
  comments        comments[]
  posts           posts[]
  tokens          Token[]
  aiProviders     UserAIProvider[]
  activities      Activity[]
  parseHistories  ParseHistory[]
  teamMemberships TeamMember[]
}

model comments {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id    String?   @db.Uuid
  author_id  String?   @db.Uuid
  content    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users?    @relation(fields: [author_id], references: [id], onUpdate: NoAction)
  posts      posts?    @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model posts {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  author_id    String?    @db.Uuid
  title        String
  content      String
  is_published Boolean?   @default(false)
  published_at DateTime?  @db.Timestamptz(6)
  created_at   DateTime?  @default(now()) @db.Timestamptz(6)
  comments     comments[]
  users        users?     @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model Token {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String      @db.Uuid
  service     String
  token       String
  description String?
  category    String?
  status      TokenStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(6)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([service])
}

enum TokenStatus {
  ACTIVE
  EXPIRED
  EXPIRING
}

model UserAIProvider {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  providerType String
  apiKey       String
  config       String?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @db.Timestamptz(6)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerType])
  @@index([userId])
}

model Activity {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  action    String
  service   String
  details   String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model ParseHistory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  input     String?
  result    String
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Team {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  ownerId     String   @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  members TeamMember[]
  tokens  TeamToken[]

  @@index([ownerId])
}

model TeamMember {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId   String   @db.Uuid
  userId   String   @db.Uuid
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now()) @db.Timestamptz(6)

  team Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model TeamToken {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId      String      @db.Uuid
  service     String
  token       String
  description String?
  category    String?
  status      TokenStatus @default(ACTIVE)
  createdBy   String      @db.Uuid
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(6)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
}
