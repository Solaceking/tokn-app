generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Supabase Auth tables (introspected)
model users {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String     @unique
  username   String     @unique
  full_name  String?
  avatar_url String?
  plan       Plan       @default(FREE)
  created_at DateTime?  @default(now()) @db.Timestamptz(6)
  comments   comments[]
  posts      posts[]
  tokens     Token[]
  aiProviders UserAIProvider[]
  activities Activity[]
  parseHistories ParseHistory[]
  teamMemberships TeamMember[]
}

enum Plan {
  FREE
  PRO
}

model comments {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id    String?   @db.Uuid
  author_id  String?   @db.Uuid
  content    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users?    @relation(fields: [author_id], references: [id], onUpdate: NoAction)
  posts      posts?    @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model posts {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  author_id    String?    @db.Uuid
  title        String
  content      String
  is_published Boolean?   @default(false)
  published_at DateTime?  @db.Timestamptz(6)
  created_at   DateTime?  @default(now()) @db.Timestamptz(6)
  comments     comments[]
  users        users?     @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

// TOKN - API Token model
model Token {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  service     String
  token       String   // Encrypted
  description String?
  category    String?
  status      TokenStatus @default(ACTIVE)
  iv          String   // Initialization vector for encryption
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([service])
}

enum TokenStatus {
  ACTIVE
  EXPIRED
  EXPIRING
}

// TOKN - User's AI Provider configurations
model UserAIProvider {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  provider     String   // deepseek, openai, google, openrouter, zai
  apiKey       String   // Encrypted
  selectedModel String?
  isDefault    Boolean  @default(false)
  iv           String   // Initialization vector for encryption
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @db.Timestamptz(6)
  
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, provider])
  @@index([userId])
}

// TOKN - Activity log
model Activity {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  action    String   // CREATE, UPDATE, DELETE, COPY, REVEAL, PARSE
  service   String?
  details   String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

// TOKN - Parse history
model ParseHistory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  provider     String
  model        String?
  inputTokens  Int?
  outputTokens Int?
  success      Boolean
  error        String?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

// TOKN - Team model (for Pro tier team collaboration)
model Team {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  ownerId     String   @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  
  members     TeamMember[]
  tokens      TeamToken[]
  
  @@index([ownerId])
}

// TOKN - Team members
model TeamMember {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId    String         @db.Uuid
  userId    String         @db.Uuid
  role      TeamRole       @default(MEMBER)
  joinedAt  DateTime       @default(now()) @db.Timestamptz(6)
  
  team      Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      users          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

// TOKN - Team-shared tokens
model TeamToken {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId      String   @db.Uuid
  service     String
  token       String   // Encrypted
  description String?
  category    String?
  status      TokenStatus @default(ACTIVE)
  iv          String   // Initialization vector for encryption
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
}
